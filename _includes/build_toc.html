{% comment %}
  --- 1. GET THE COLLECTION TO USE ---
  Get the collection name from the "toc_collection" variable
  in the page's Front Matter.
{% endcomment %}
{% assign collection_name = page.toc_collection %}
{% assign collection_data = site[collection_name] %}

{% if collection_data == nil %}
  <p style="color: red;">
    <strong>Error:</strong> No collection found with name '{{ collection_name }}'.
    Check the 'toc_collection' Front Matter on this page.
  </p>
{% else %}

  {% comment %}
    --- 2. SORT & GROUP THE COLLECTION ---
  {% endcomment %}
  {% assign all_pages_sorted = collection_data | sort: 'part_order' | sort: 'chapter_order' %}
  {% assign pages_by_chapter = all_pages_sorted | group_by: 'chapter_title' %}

  <h2>Table of Contents</h2>

  <ul style="list-style-type: none; padding-left: 0;">
    {% for chapter in pages_by_chapter %}

      {% if chapter.items.size == 1 %}
        {% assign page = chapter.items[0] %}
        <li>
          <a href="{{ page.url | relative_url }}">{{ page.title }}</a>
          {% if page.read_time %} ({{ page.read_time }} min){% endif %}
        </li>
      {% else %}
        <li>
          <strong>{{ chapter.name }}</strong>
          {% assign total_time = 0 %}
          {% for page in chapter.items %}
            {% if page.read_time %}{% assign total_time = total_time | plus: page.read_time %}{% endif %}
          {% endfor %}
          <ul style="list-style-type: none; padding-left: 20px;">
            {% for page in chapter.items %}
              <li>
                <a href="{{ page.url | relative_url }}">{{ page.title }}</a>
                {% if page.read_time %} ({{ page.read_time }} min){% endif %}
            </li>
            {% endfor %}
          </ul>
        </li>
      {% endif %}

    {% endfor %}
  </ul>

{% endif %}